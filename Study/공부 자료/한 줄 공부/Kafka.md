카프카는 분산 이벤트 스트리밍 플랫폼이다. 대용량 데이터 스트리밍을 처리하고 저장할 수 있는 오픈 소스 솔루션이다. 주로 이벤트 스트리밍, 데이터 파이프라인 및 실시간 데이터 피드를 구축하는데 사용한다.

카프카는 실시간 데이터 피드를 처리하기위해 설계되었고, 대용량의 데이터 스트림을 효율적으로 발행, 구독, 저장, 처리할 수 있다. 
고성능, 확장성, 내구성, 고가용성을 제공하며, 로그 수집, 메세지 큐잉, 스트림 처리, 이벤트 소싱 등 다양한 곳에서 활용된다.

- 모든 시스템으로 데이터를 실시간으로 전송하여 처리할 수 있는 시스템
- 데이터가 많아져도 확장이 용이한 시스템

![[Pasted image 20240411205640.png]]

![[Pasted image 20240411205659.png]]

데이터가 어떤 시스템에 저장되는지 관계하지 않고 무조건 Kafka만 상대하면 된다.
카프카에 쌓인 데이터 메세지들도, 서비스들에 데이터를 전달해줄 때 카프카에서 받아오면 되기 때문에 단일 포맷을 사용할 수 있다.





## 기본 구조

### 카프카 클러스터

메세지를 저장하는 저장소이다.
하나의 카프카 클러스터는 여러 개 브로커(서버로 보면 됨)로 구성 된다. 

### 주키퍼 클러스터(앙상블)

카프카 클러스터를 관리해주는 것을 말한다.
카프카 클러스터에 관련된 정보가 기록되고 관리된다.

### 프로듀서

카프카 클러스터에 메세지를 보내는 역할

### 컨슈머

메세지를 카프카에서 읽어오는 역할

![[Pasted image 20240109184358.png]]

<br>

## 토픽과 파티션

- 토픽은 메세지를 구분하는 단위 (파일 시스템의 폴더와 유사함)
- 한 개의 토픽은 한 개 이상의 파티션으로 구성
	- 파티션은 메세지를 저장하는 물리적인 파일

프로듀서는 메세지를 저장할 때 어떤 토픽에 저장
컨슈머는 어떤 토픽에서 메세지를 읽어옴

![[Pasted image 20240109184417.png]]

<br>

## 파티션과 오프셋, 메세지 순서

기본적으로 파티션은 추가만 가능한(append-only) 파일이다.

- 각 메세지 저장 위치를 오프셋(offset) 이라고 한다.
- 프로듀서가 넣은 메세지는 파티션의 맨 뒤에 추가됨
- 컨슈머는 오프셋 기준으로 메세지를 순서대로 읽음
- 메세지는 삭제되지 않음 (설정에 따라 일정 시간이 지난 뒤 삭제 가능)

<br>

## 여러 파티션과 프로듀서

- 프로듀서는 라운드로빈 또는 키로 파티션 선택
	- 같은 키를 갖는 메세지는 같은 파티션에 저장

<br>

## 여러 파티션과 컨슈머

- 컨슈머는 컨슈머 그룹에 속한다.
- 한 개의 파티션은 컨슈머 그룹의 한 개의 컨슈머만 연결 가능
	- 컨슈머 그룹에 속한 컨슈머들은한 파티션을 공유할 수 없음
	- 한 컨슈머 그룹 기준으로 파티션의 메세지는 순서대로 처리

컨슈머 그룹의 한 개의 컨슈머만 한 개의 파티션을 연결할 수 있기 때문에 파티션의 메세지가 순서대로 처리되는 것을 보장한다.

<br>

## 성능

- 파티션 파일은 OS 페이지 캐시 사용함
	- 파티션에 대한 파일 IO를 메모리에서 처리
- Zero Copy
	- 디스크 버퍼에서 네트워크 버퍼로 직접 데이터 복사
- 컨슈머 추적을 위해 브로커가 하는 일이 비교적 단순함
	- 메세지 필터, 메세지 재전송 같은 일을 브로커가 하지 않음 (프로듀서, 컨슈머가 직접)
	- 브로커는 컨슈머와 파티션 간 매핑 관리
- 묶어서 보내기, 묶어서 받기 (batch)
	- 프로듀서 : 일정 크기만큼 메세지를 모아서 전송 가능
	- 컨슈머 : 최소 크기만큼 메세지를 모아서 조회 가능
- 낱개 처리보다 처리량 증가
- 처리량 확장이 쉬움
	- 장비 용량 한계 -> 브로커 추가, 파티션 추가
	- 컨슈머가 느림 -> 컨슈머 추가 (+파티션 추가)

<br>

## 리플리카

- 리플리카 : 파티션의 복제본
	- 복제수 만큼 파티션 복제본이 각 브로커에 생김
- 리더와 팔로워로 구성
	- 프로듀서와 컨슈머는 리더를 통해서만 메세지 처리
	- 팔로워는 리더로부터 복제
- 장애 대응
	- 리더가 속한 브로커 장애 시 다른 팔로워가 리더가 됨
